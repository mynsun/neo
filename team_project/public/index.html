<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EV ì¶©ì „ì†Œ ì§€ë„</title>
<link rel="stylesheet" href="/map.css" />
<style>
    #station-detail {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: none;
    }
    #station-detail h3 {
        margin-bottom: 10px;
        font-size: 18px;
    }
    .station-detail-item {
        margin-bottom: 8px;
    }
</style>
</head>
<body>
<div class="wrapper">
    <main class="map-container">
        <div id="map" style="width:100%;height:500px;"></div>
    </main>
    <aside class="info-panel">
        <h2>ì¶©ì „ì†Œ ì •ë³´</h2>
        <div id="station-info">
            <p>ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì¶©ì „ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <label for="address">ì£¼ì†Œ ì…ë ¥:</label>
        <input type="text" id="address" placeholder="ì˜ˆ: ê°•ë‚¨ì—­" />
        <button onclick="getStationsByAddress()">ì£¼ì†Œë¡œ ì¡°íšŒ</button>
        <button onclick="getNearbyStations()">í˜„ì¬ ìœ„ì¹˜ë¡œ ì¡°íšŒ</button><br>

        <!-- ğŸ”¹ ê²½ë¡œ ê¸°ë°˜ ì¡°íšŒ UI -->
        <label for="start">ì¶œë°œì§€:</label>
        <input type="text" id="start" placeholder="ì˜ˆ: ì„œìš¸ì—­" />
        <label for="end">ë„ì°©ì§€:</label>
        <input type="text" id="end" placeholder="ì˜ˆ: ê°•ë¦‰ì—­" />
        <label for="range">ì£¼í–‰ ê°€ëŠ¥ ê±°ë¦¬ (m):</label>
        <input type="number" id="range" placeholder="ì˜ˆ: 2000" min="1" />
        <button onclick="getStationsByRoute()">ê²½ë¡œ ê¸°ë°˜ ì¡°íšŒ</button>

        <div id="result"></div>

        <div id="station-detail">
            <h3>ì¶©ì „ì†Œ ìƒì„¸ ì •ë³´</h3>
            <div id="detailed-info">
                <p>ì¶©ì „ì†Œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </aside>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f4708cdafa0fb8c0ee209515bed953ea"></script>
<script>
    let map;
    let markers = [];

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }

    function addMarkers(stations) {
        clearMarkers();

        if (stations.length > 0) {
            const firstStation = stations[0];
            const firstPosition = new kakao.maps.LatLng(firstStation["ìœ„ë„"], firstStation["ê²½ë„"]);
            map.setCenter(firstPosition);
        }

        stations.forEach(station => {
            const lat = station["ìœ„ë„"];
            const lon = station["ê²½ë„"];
            const markerPosition = new kakao.maps.LatLng(lat, lon);

            const marker = new kakao.maps.Marker({
                position: markerPosition,
                title: station["ì¶©ì „ì†Œëª…"]
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                displayStationDetail(station);
            });

            marker.setMap(map);
            markers.push(marker);
        });
    }

    function displayStationDetail(station) {
        const container = document.getElementById("detailed-info");
        container.innerHTML = `
            <div class="station-detail-item"><strong>ì¶©ì „ì†Œëª…:</strong> ${station["ì¶©ì „ì†Œëª…"]}</div>
            <div class="station-detail-item"><strong>ì£¼ì†Œ:</strong> ${station["ì£¼ì†Œ"]}</div>
            <div class="station-detail-item"><strong>ì¶©ì „ê¸° íƒ€ì…:</strong> ${station["ì¶©ì „ê¸°íƒ€ì…"]}</div>
            <div class="station-detail-item"><strong>ì„¤ì¹˜ë…„ë„:</strong> ${station["ì„¤ì¹˜ë…„ë„"] ?? 'ì •ë³´ ì—†ìŒ'}</div>
            <div class="station-detail-item"><strong>ì´ìš©ì ì œí•œ:</strong> ${station["ì´ìš©ìì œí•œ"] ?? 'ì œí•œ ì—†ìŒ'}</div>
        `;

        document.getElementById("result").style.display = 'none';
        document.getElementById("station-detail").style.display = 'block';
    }

    function displayStations(data, method) {
        const container = document.getElementById("result");
        container.style.display = 'block';
        document.getElementById("station-detail").style.display = 'none';

        if (!data.charging_stations || data.charging_stations.length === 0) {
            container.innerHTML = `<p>ì¶©ì „ì†Œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }

        container.innerHTML = `
            <p><strong>${
                method === "address"
                    ? "ì£¼ì†Œ ê¸°ë°˜ ì¡°íšŒ"
                    : method === "route"
                    ? "ê²½ë¡œ ê¸°ë°˜ ì¡°íšŒ"
                    : "í˜„ì¬ ìœ„ì¹˜ ì¡°íšŒ"
            }</strong></p>
            <p>(ì¡°íšŒ ë°˜ê²½: ${data["ë°˜ê²½(m)"]}m)</p>
            <p>ì´ ${data["ì¶©ì „ì†Œ ìˆ˜"]}ê°œ ì¶©ì „ì†Œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</p>
        `;

        data.charging_stations.forEach(station => {
            container.innerHTML += `
                <div class="station">
                    <strong>${station["ì¶©ì „ì†Œëª…"]}</strong><br>
                    ì£¼ì†Œ: ${station["ì£¼ì†Œ"]}<br>
                    ê±°ë¦¬: ${station["ê±°ë¦¬(m)"]}m<br>
                    ì¶©ì „ê¸° íƒ€ì…: ${station["ì¶©ì „ê¸°íƒ€ì…"]}<br>
                    ì„¤ì¹˜ë…„ë„: ${station["ì„¤ì¹˜ë…„ë„"] ?? 'ì •ë³´ ì—†ìŒ'}<br>
                    ì´ìš©ì ì œí•œ: ${station["ì´ìš©ìì œí•œ"] ?? 'ì œí•œ ì—†ìŒ'}<br>
                    <hr>
                </div>
            `;
        });

        addMarkers(data.charging_stations);
    }

    function getNearbyStations() {
        const lat = 37.4946121541249;
        const lon = 127.02757944598672;
        const radius = 2000;

        fetch(`http://192.168.1.46:3000/r_nearby?latitude=${lat}&longitude=${lon}&radius=${radius}`)
            .then(response => response.json())
            .then(data => displayStations(data, "location"))
            .catch(err => {
                console.error("API í˜¸ì¶œ ì‹¤íŒ¨", err);
                alert("ì¶©ì „ì†Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    function getStationsByAddress() {
        const address = document.getElementById("address").value.trim();
        if (!address) {
            alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const radius = 2000;

        fetch(`http://192.168.1.46:3000/r_by_address?address=${encodeURIComponent(address)}&radius=${radius}`)
            .then(response => response.json())
            .then(data => displayStations(data, "address"))
            .catch(err => {
                console.error("API í˜¸ì¶œ ì‹¤íŒ¨", err);
                alert("ì¶©ì „ì†Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // ğŸ”¹ ê²½ë¡œ ê¸°ë°˜ ì¶©ì „ì†Œ ì¡°íšŒ í•¨ìˆ˜
    function getStationsByRoute() {
    const start = document.getElementById("start").value.trim();
    const end = document.getElementById("end").value.trim();
    const range = parseInt(document.getElementById("range").value.trim());
    const radius = 2000;

    if (!start || !end || isNaN(range)) {
        alert("ì¶œë°œì§€, ë„ì°©ì§€, ì£¼í–‰ ê°€ëŠ¥ ê±°ë¦¬(m)ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    const url = `http://192.168.1.46:3000/r_route?start_address=${encodeURIComponent(start)}&end_address=${encodeURIComponent(end)}&range=${range}`;
    console.log("API URL:", url);  // ìš”ì²­ URLì„ ë¡œê·¸ë¡œ í™•ì¸

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");
            }
            return response.json();
        })
        .then(data => displayStations(data, "route"))
        .catch(err => {
            console.error("API í˜¸ì¶œ ì‹¤íŒ¨", err);
            alert("ê²½ë¡œ ê¸°ë°˜ ì¶©ì „ì†Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
}



    function showCurrentLocationOnMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                console.log("í˜„ì¬ ìœ„ì¹˜ ìœ„ë„/ê²½ë„:", lat, lon);

                const locPosition = new kakao.maps.LatLng(lat, lon);

                const marker = new kakao.maps.Marker({
                    position: locPosition,
                    map: map,
                    title: "í˜„ì¬ ìœ„ì¹˜",
                    image: new kakao.maps.MarkerImage(
                        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                        new kakao.maps.Size(24, 35)
                    )
                });

                const infowindow = new kakao.maps.InfoWindow({
                    content: "<div style='padding:5px;'>ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>"
                });
                infowindow.open(map, marker);
            });
        }
    }

    function initMap() {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.4946121541249, 127.02757944598672),
            level: 4
        };
        map = new kakao.maps.Map(container, options);

        getNearbyStations();
        showCurrentLocationOnMap();
    }

    window.onload = initMap;
</script>
</body>
</html>
